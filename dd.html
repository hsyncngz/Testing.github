<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DURU - Özbek Enerji App</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        :root {
            --bg-color: #0f1014;
            --card-bg: #1a1c23;
            --text-main: #ffffff;
            --ticker-bg: #16171d;
            --ozbek-red: #ff4d4d;
            --enerji-blue: #00a2ff;
            --dim-text: #888888;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow-x: hidden; }
        #main-content { padding-bottom: 50px; }
        .swiper { width: 92%; border-radius: 12px; margin-top: 15px; aspect-ratio: 16/9; }
        .swiper-slide a { display: block; width: 100%; height: 100%; }
        .swiper-slide img { width: 100%; height: 100%; object-fit: cover; }
        .card { display: flex; background: var(--card-bg); border-radius: 12px; margin: 10px 15px; padding: 10px; text-decoration: none; color: inherit; align-items: center; transition: transform 0.2s; }
        .card:active { transform: scale(0.98); }
        .card-img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; margin-right: 12px; background: #252833; flex-shrink: 0; }
        
        .ticker-wrapper { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--ticker-bg); height: 38px; display: flex; align-items: center; z-index: 1000; border-top: 1px solid #222; overflow: hidden; }
        .ticker-content { display: flex; white-space: nowrap; animation: tickerSlide 25s linear infinite; }
        .ticker-item { display: flex; align-items: center; padding: 0 35px; font-size: 13px; font-weight: 600; }
        .cur-name { color: var(--dim-text); font-size: 11px; margin-right: 6px; font-weight: 400; }
        .brand-item { font-weight: 700; font-size: 14px; }
        @keyframes tickerSlide { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
    </style>
</head>
<body>

    <div id="main-content">
        <div class="swiper mySwiper">
            <div class="swiper-wrapper" id="slider-target"></div>
            <div class="swiper-pagination"></div>
        </div>
        <div id="cards-target"></div>
    </div>

    <div class="ticker-wrapper">
        <div class="ticker-content" id="ticker-target">Veriler güncelleniyor...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        const dataSources = {
            bakir: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR2HG_EhDiTB7QAiDqWO5rOxB8RmRwTdVaiNYKCklahAEF3jb0TO4TUss-R5q-lp3byjEDBmKgkuKyP/pub?gid=0&single=true&output=csv',
            usd: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR2HG_EhDiTB7QAiDqWO5rOxB8RmRwTdVaiNYKCklahAEF3jb0TO4TUss-R5q-lp3byjEDBmKgkuKyP/pub?gid=557933778&single=true&output=csv',
            euro: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR2HG_EhDiTB7QAiDqWO5rOxB8RmRwTdVaiNYKCklahAEF3jb0TO4TUss-R5q-lp3byjEDBmKgkuKyP/pub?gid=678328637&single=true&output=csv'
        };

        // KESİN ÇÖZÜM: Formatlama fonksiyonu
        function formatDuru(val) {
            if (!val) return "0,00";
            
            // Tırnakları ve boşlukları temizle
            let clean = val.toString().replace(/"/g, '').trim();
            
            // Eğer "13.768,25" gibi geliyorsa; noktayı at, virgülü nokta yap
            if (clean.includes('.') && clean.includes(',')) {
                clean = clean.replace(/\./g, '').replace(',', '.');
            } 
            // Eğer sadece "13768,25" geliyorsa; virgülü nokta yap
            else if (clean.includes(',')) {
                clean = clean.replace(',', '.');
            }
            // Eğer sadece "13.768" geliyorsa ve binlikse (genelde Google Sheets hatasıdır)
            // Bu kısım riskli olduğu için düz sayıya çeviriyoruz.
            
            let num = parseFloat(clean);
            if (isNaN(num)) return "0,00";

            // TR formatına zorla: 13.768,25
            return new Intl.NumberFormat('tr-TR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }

        async function getVal(url) {
            try {
                const res = await fetch(url + '&cache=' + Date.now());
                const text = await res.text();
                // Satırı al ve her türlü ayırıcıdan kurtulup saf veriyi döndür
                return text.split(/\r?\n/)[0].split(',')[0].split(';')[0];
            } catch (e) { return "0,00"; }
        }

        async function fetchMarketData() {
            try {
                const [rB, rU, rE] = await Promise.all([
                    getVal(dataSources.bakir),
                    getVal(dataSources.usd),
                    getVal(dataSources.euro)
                ]);

                const items = `
                    <div class="ticker-item"><span class="cur-name">BAKIR</span><span style="color:#fff">${formatDuru(rB)}</span></div>
                    <div class="ticker-item brand-item"><span style="color:var(--ozbek-red)">Özbek</span> <span style="color:var(--enerji-blue)">Enerji</span></div>
                    <div class="ticker-item"><span class="cur-name">USD</span><span style="color:#fff">${formatDuru(rU)}</span><span style="color:#555; margin-left:2px">₺</span></div>
                    <div class="ticker-item brand-item"><span style="color:var(--ozbek-red)">Özbek</span> <span style="color:var(--enerji-blue)">Enerji</span></div>
                    <div class="ticker-item"><span class="cur-name">EUR</span><span style="color:#fff">${formatDuru(rE)}</span><span style="color:#555; margin-left:2px">₺</span></div>
                    <div class="ticker-item brand-item"><span style="color:var(--ozbek-red)">Özbek</span> <span style="color:var(--enerji-blue)">Enerji</span></div>
                `;
                document.getElementById('ticker-target').innerHTML = items + items;
            } catch (e) { console.error("Veri hatası."); }
        }

        // Slider ve Kart fonksiyonları aynen bırakıldı...
        function csvToJSON(csv) {
            const lines = csv.split("\n");
            const headers = lines[0].split(",").map(h => h.trim().replace(/"/g, ""));
            return lines.slice(1).filter(l => l.trim()).map(line => {
                const data = line.split(",");
                const obj = {};
                headers.forEach((h, i) => { obj[h] = data[i] ? data[i].trim().replace(/"/g, "") : ""; });
                return obj;
            });
        }

        function renderSlider(data) {
            document.getElementById('slider-target').innerHTML = data.map(i => `
                <div class="swiper-slide"><a href="${i.link || '#'}" target="_blank"><img src="${i.resim}" loading="lazy"></a></div>
            `).join('');
            new Swiper(".mySwiper", { loop: true, autoplay: { delay: 3500 }, pagination: { el: ".swiper-pagination", clickable: true } });
        }

        function renderCards(data) {
            document.getElementById('cards-target').innerHTML = data.map(i => `
                <a href="${i.link || '#'}" class="card" target="_blank">
                    <img src="${i.resim}" class="card-img" loading="lazy">
                    <div class="card-info">
                        <h4 style="margin:0; font-size:13px; font-weight:700;">${i.baslik}</h4>
                        <p style="margin:4px 0 0; font-size:11px; color:var(--dim-text); line-height:1.4;">${i.ozet}</p>
                    </div>
                </a>`).join('');
        }

        async function init() {
            fetchMarketData();
            setInterval(fetchMarketData, 60000);

            const sUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTwx01OUeHg0s-HvXa9duTL8gLVBv6rwH_uFWpjztnGINVUqkJbqjh75bohMWfUrLcHLdf0E30ahiqi/pub?output=csv";
            const cUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTQQeZrYsmqg7osozS-Pbj0W3kY9BkCq-BIjXhBYHhC0UDLIU-RK-FKWfYH7VSWieksv82vXd7lZVTT/pub?output=csv";

            const cachedSlider = localStorage.getItem("sliderData");
            const cachedCards = localStorage.getItem("cardsData");

            if (cachedSlider && cachedCards) {
                renderSlider(JSON.parse(cachedSlider));
                renderCards(JSON.parse(cachedCards));
            }

            try {
                const [rS, rC] = await Promise.all([
                    fetch(sUrl).then(r => r.text()),
                    fetch(cUrl).then(r => r.text())
                ]);
                const sliderData = csvToJSON(rS);
                const cardsData = csvToJSON(rC);
                if (JSON.stringify(sliderData) !== cachedSlider) {
                    localStorage.setItem("sliderData", JSON.stringify(sliderData));
                    renderSlider(sliderData);
                }
                if (JSON.stringify(cardsData) !== cachedCards) {
                    localStorage.setItem("cardsData", JSON.stringify(cardsData));
                    renderCards(cardsData);
                }
            } catch (e) { console.error("Hata."); }
        }

        window.onload = init;
    </script>
</body>
</html>
