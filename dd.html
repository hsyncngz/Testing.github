<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Özbek Enerji App</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        :root {
            --bg-color: #0f1014;
            --card-bg: #1a1c23;
            --text-main: #ffffff;
            --ticker-bg: #16171d;
            --ozbek-red: #ff4d4d;
            --enerji-blue: #00a2ff;
            --dim-text: #888888;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow-x: hidden; }
        #main-content { padding-bottom: 50px; }
        .swiper { width: 92%; border-radius: 12px; margin-top: 15px; aspect-ratio: 16/9; }
        .swiper-slide a { display: block; width: 100%; height: 100%; }
        .swiper-slide img { width: 100%; height: 100%; object-fit: cover; }
        .card { display: flex; background: var(--card-bg); border-radius: 12px; margin: 10px 15px; padding: 10px; text-decoration: none; color: inherit; align-items: center; transition: transform 0.2s; }
        .card:active { transform: scale(0.98); }
        .card-img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; margin-right: 12px; background: #252833; flex-shrink: 0; }
        
        /* Ticker Stili */
        .ticker-wrapper { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--ticker-bg); height: 38px; display: flex; align-items: center; z-index: 1000; border-top: 1px solid #222; overflow: hidden; }
        .ticker-content { display: flex; white-space: nowrap; animation: tickerSlide 25s linear infinite; }
        .ticker-item { display: flex; align-items: center; padding: 0 35px; font-size: 13px; font-weight: 600; }
        .cur-name { color: var(--dim-text); font-size: 11px; margin-right: 6px; font-weight: 400; }
        .brand-item { font-weight: 700; font-size: 14px; }
        @keyframes tickerSlide { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
    </style>
</head>
<body>

    <div id="main-content">
        <div class="swiper mySwiper">
            <div class="swiper-wrapper" id="slider-target"></div>
            <div class="swiper-pagination"></div>
        </div>
        <div id="cards-target"></div>
    </div>

    <div class="ticker-wrapper">
        <div class="ticker-content" id="ticker-target"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        // CSV Dönüştürücü (Slider ve Kartlar için)
        function csvToJSON(csv) {
            const lines = csv.split(/\r?\n/);
            if (lines.length < 1) return [];
            const sep = lines[0].includes(';') ? ';' : ',';
            const headers = lines[0].split(sep).map(h => h.trim().replace(/"/g, "").toLowerCase());
            return lines.slice(1).filter(l => l.trim()).map(line => {
                const data = line.split(sep);
                const obj = {};
                headers.forEach((h, i) => { obj[h] = data[i] ? data[i].trim().replace(/"/g, "") : ""; });
                return obj;
            });
        }

        // Market Verilerini Çekme ve Formatlama (Bakır, USD, EURO)
        async function fetchMarketData() {
            const mUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR2HG_EhDiTB7QAiDqWO5rOxB8RmRwTdVaiNYKCklahAEF3jb0TO4TUss-R5q-lp3byjEDBmKgkuKyP/pub?output=csv";
            
            try {
                const res = await fetch(mUrl + "&cache_bust=" + Date.now());
                const csvText = await res.text();
                
                const lines = csvText.split(/\r?\n/);
                if (lines.length > 1) {
                    const dataRow = lines[1].split(/[,;]/); 
                    
                    // Sayıyı Türkiye formatına (13.212,28) dönüştüren yardımcı fonksiyon
                    const formatTR = (val) => {
                        if (!val) return "---";
                        let raw = val.replace(/"/g, "").trim();
                        // Sayıyı temizle ve float'a çevir
                        let num = parseFloat(raw.replace(",", ".")); 
                        
                        if (isNaN(num)) return raw;

                        return new Intl.NumberFormat('tr-TR', { 
                            minimumFractionDigits: 2, 
                            maximumFractionDigits: 2 
                        }).format(num);
                    };

                    const b = formatTR(dataRow[0]); // Bakır
                    const u = formatTR(dataRow[1]); // USD
                    const e = formatTR(dataRow[2]); // EURO

                    if (b.includes('#') || u.includes('#')) throw new Error("Veri hatası");

                    const items = `
                        <div class="ticker-item"><span class="cur-name">BAKIR</span><span style="color:#fff">${b}</span><span style="color:#555; margin-left:2px">$</span></div>
                        <div class="ticker-item brand-item"><span style="color:var(--ozbek-red)">Özbek</span> <span style="color:var(--enerji-blue)">Enerji</span></div>
                        <div class="ticker-item"><span class="cur-name">USD</span><span style="color:#fff">${u}</span><span style="color:#555; margin-left:2px">₺</span></div>
                        <div class="ticker-item brand-item"><span style="color:var(--ozbek-red)">Özbek</span> <span style="color:var(--enerji-blue)">Enerji</span></div>
                        <div class="ticker-item"><span class="cur-name">EURO</span><span style="color:#fff">${e}</span><span style="color:#555; margin-left:2px">₺</span></div>
                        <div class="ticker-item brand-item"><span style="color:var(--ozbek-red)">Özbek</span> <span style="color:var(--enerji-blue)">Enerji</span></div>
                    `;
                    // Kayan yazı akışkanlığı için içeriği çoğaltıyoruz
                    document.getElementById('ticker-target').innerHTML = items + items + items;
                }
            } catch (err) {
                console.log("Veri çekilemedi, tekrar deneniyor...");
                setTimeout(fetchMarketData, 5000);
            }
        }

        function renderSlider(data) {
            document.getElementById('slider-target').innerHTML = data.map(i => `
                <div class="swiper-slide">
                    <a href="${i.link || '#'}" target="_blank">
                        <img src="${i.resim}" loading="lazy">
                    </a>
                </div>
            `).join('');
            new Swiper(".mySwiper", { loop: true, autoplay: { delay: 3500 }, pagination: { el: ".swiper-pagination", clickable: true } });
        }

        function renderCards(data) {
            document.getElementById('cards-target').innerHTML = data.map(i => `
                <a href="${i.link || '#'}" class="card" target="_blank">
                    <img src="${i.resim}" class="card-img" loading="lazy">
                    <div class="card-info">
                        <h4 style="margin:0; font-size:13px; font-weight:700;">${i.baslik}</h4>
                        <p style="margin:4px 0 0; font-size:11px; color:var(--dim-text); line-height:1.4;">${i.ozet}</p>
                    </div>
                </a>`).join('');
        }

        async function init() {
            fetchMarketData();
            const sUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTwx01OUeHg0s-HvXa9duTL8gLVBv6rwH_uFWpjztnGINVUqkJbqjh75bohMWfUrLcHLdf0E30ahiqi/pub?output=csv";
            const cUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTQQeZrYsmqg7osozS-Pbj0W3kY9BkCq-BIjXhBYHhC0UDLIU-RK-FKWfYH7VSWieksv82vXd7lZVTT/pub?output=csv";
            
            const cachedSlider = localStorage.getItem("sliderData");
            const cachedCards = localStorage.getItem("cardsData");
            
            if (cachedSlider && cachedCards) {
                renderSlider(JSON.parse(cachedSlider));
                renderCards(JSON.parse(cachedCards));
            }

            try {
                const [rS, rC] = await Promise.all([
                    fetch(sUrl).then(r => r.text()),
                    fetch(cUrl).then(r => r.text())
                ]);
                const sliderData = csvToJSON(rS);
                const cardsData = csvToJSON(rC);
                
                if (JSON.stringify(sliderData) !== cachedSlider) {
                    localStorage.setItem("sliderData", JSON.stringify(sliderData));
                    renderSlider(sliderData);
                }
                if (JSON.stringify(cardsData) !== cachedCards) {
                    localStorage.setItem("cardsData", JSON.stringify(cardsData));
                    renderCards(cardsData);
                }
            } catch (e) { console.error("Slider/Kart hatası."); }
        }

        window.onload = init;
    </script>
</body>
</html>
